alias: New Heat management
description: ""
# Heat management automation: sets radiator temperatures based on presence, sleep mode, and zones
triggers:
  # Trigger: someone enters or leaves home zone
  - entity_id: zone.home
    trigger: state
  # Trigger: someone enters or leaves 20km zone
  - entity_id: zone.20km_zone
    trigger: state
  # Trigger: home presence helper changes
  - entity_id: input_boolean.home_pressence_detected
    trigger: state
  # Trigger: sleep mode toggled on
  - entity_id: switch.toggle_sleep_mode
    from: "off"
    to: "on"
    trigger: state
conditions: []
  # No extra conditions
actions:
  # Choose block: set temperature based on presence, sleep mode, and zones
  - choose:
      # If someone is home and not sleeping, set comfortable temperature
      - conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.toggle_sleep_mode
                state: "off"
              - condition: state
                entity_id: input_boolean.home_pressence_detected
                state: "on"
        sequence:
          # Set temperature to 22째C (comfort)
          - action: climate.set_temperature
            metadata: {}
            data:
              temperature: 22
            target:
              entity_id:
                - climate.danfoss_etrv0100
                - climate.danfoss_etrv0100_2
                - climate.danfoss_etrv0100_3
        alias: Set comfortable temperature
      # If someone is within 20km, but not home, and not sleeping, set idle temperature
      - conditions:
          - condition: template
            value_template: >-
              {{ (state_attr('zone.20km_zone', 'persons') | default([])) |
              length > 0 }}
          - condition: and
            conditions:
              - condition: state
                entity_id: switch.toggle_sleep_mode
                state: "off"
              - condition: state
                entity_id: input_boolean.home_pressence_detected
                state: "off"
        sequence:
          # Set temperature to 20째C (idle)
          - action: climate.set_temperature
            metadata: {}
            data:
              temperature: 20
            target:
              entity_id:
                - climate.danfoss_etrv0100_2
                - climate.danfoss_etrv0100
                - climate.danfoss_etrv0100_3
        alias: Set idle temperature
      # If no one is home or in 20km zone, and not sleeping, set low temperature
      - conditions:
          - condition: state
            entity_id: zone.home
            attribute: persons
            state: "0"
          - condition: state
            entity_id: zone.20km_zone
            attribute: persons
            state: "0"
          - condition: state
            entity_id: switch.toggle_sleep_mode
            state: "off"
          - condition: state
            entity_id: input_boolean.home_pressence_detected
            state: "off"
        sequence:
          # Set temperature to 16째C (low)
          - action: climate.set_temperature
            metadata: {}
            data:
              temperature: 16
            target:
              entity_id:
                - climate.danfoss_etrv0100_2
                - climate.danfoss_etrv0100
                - climate.danfoss_etrv0100_3
        alias: Set low temperature
      # If someone is home and sleep mode is on, set sleep temperature
      - conditions:
          - condition: and
            conditions:
              - condition: state
                entity_id: input_boolean.home_pressence_detected
                state: "on"
              - condition: state
                entity_id: switch.toggle_sleep_mode
                state: "on"
        sequence:
          # Set temperature to 19째C (sleep)
          - action: climate.set_temperature
            metadata: {}
            data:
              temperature: 19
            target:
              entity_id:
                - climate.danfoss_etrv0100_2
                - climate.danfoss_etrv0100
                - climate.danfoss_etrv0100_3
        alias: Set sleep temperature
mode: single
# Only one instance runs at a time
